name: PR æµæ°´çº¿ç›‘æ§ç³»ç»Ÿ

on:
  # å®šæœŸæ£€æŸ¥ PR çŠ¶æ€ (æ¯ 5 åˆ†é’Ÿ)
  schedule:
    - cron: '*/5 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼ºåˆ¶æ£€æŸ¥æ‰€æœ‰ PR'
        required: false
        default: 'false'
  
  # PR äº‹ä»¶è§¦å‘
  pull_request:
    types: [opened, synchronize, reopened, closed]
  
  # å·¥ä½œæµå®Œæˆäº‹ä»¶
  workflow_run:
    workflows: ["React + Vite CI/CD Pipeline"]
    types: [completed]

concurrency:
  group: pr-monitor-${{ github.ref }}
  cancel-in-progress: true

jobs:
  monitor-prs:
    name: ç›‘æ§ PR æµæ°´çº¿çŠ¶æ€
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ›’ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1

    - name: âš¡ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm install @actions/core @actions/github axios

    - name: ğŸ” æ‰§è¡Œ PR çŠ¶æ€ç›‘æ§
      id: monitor
      run: node .github/scripts/pr-monitor.js
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}
        FORCE_CHECK: ${{ github.event.inputs.force_check || 'false' }}
        
    - name: ğŸ“Š è¾“å‡ºç›‘æ§ç»“æœ
      run: |
        echo "ğŸ¯ PR ç›‘æ§å®Œæˆ"
        echo "æ£€æŸ¥çš„ PR æ•°é‡: ${{ steps.monitor.outputs.checked_prs }}"
        echo "å¤±è´¥çš„æµæ°´çº¿: ${{ steps.monitor.outputs.failed_pipelines }}"
        echo "æˆåŠŸçš„æµæ°´çº¿: ${{ steps.monitor.outputs.successful_pipelines }}"
        echo "åˆ›å»ºçš„ Issue: ${{ steps.monitor.outputs.created_issues }}"
        echo "å…³é—­çš„ Issue: ${{ steps.monitor.outputs.closed_issues }}"

  # æ¸…ç†è¿‡æœŸæ•°æ®
  cleanup:
    name: æ¸…ç†è¿‡æœŸç›‘æ§æ•°æ®
    runs-on: ubuntu-latest
    needs: monitor-prs
    if: always() && (github.event_name == 'schedule' || github.event.inputs.force_check == 'true')
    
    steps:
    - name: ğŸ›’ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš¡ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm install @actions/core @actions/github

    - name: ğŸ§¹ æ¸…ç†è¿‡æœŸæ•°æ®
      run: node .github/scripts/cleanup-monitor-data.js
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPOSITORY: ${{ github.repository }}